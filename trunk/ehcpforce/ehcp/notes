unattended can be "unattended"

installmode=extra
or
#installmode=normal  implied as the norm...
installmode=light

noapt can be noapt  (don't actually do apt-based commands if defined!)


=== program operation

checkUser
ehcpheader (stage 1)
apparmor stop
apparmor teardown
checkDistro
killallEhcp

checkaptget
updatebeforeinstall
mkdir /etc/ehcp

apt-get_update
apt-getinstall
	php5,php=mysql,php-cli
	sudo,wget,aptitude
		can install debconf-utils

checkphp

run install_1.php
	include install_lib.php
	initialize()
		set infomailusingwget
		apparmor stop
		mkdir -p /etc/ehcp
		cp /etc/apt/sources.list /etc/apt/sources.list.bck.ehcp
		editinlinefile... /etc/apt/sources.list replace #deb lines with deb (allow universal, etc packages)
		getlocalip2
		hostname
		passthrough hostname myserver
		bosluk (echo \n\n\n)
		ehcpheader*()
		bosluk
		bekle (press enter to continue)
		$app=new Aplication...
		$app->commandline=true;
		installmysql 
			----> apt-get install mysql-server, mysql-client, 
			fix /etc/mysql/my.cnf 
			stopmysql
			kill -9 all mysql daemons
			restart mysql
		sleep
		getinputs (name, email, etc)
			in here is set ehcpinstalldir == /var/www/new/ehcp
		infomailusingwget...
		mkdir -p $app->conf['namedbase'] --> for doing named/bind9
		checkaptget
		extra|normal
			install unrar,rar,unzip,zipo,mc,lynx,nmap
		light
			install openssh-server,python-mysqldb,pythoncherrypy3,apache2,bind9,php5-gd,libapahe-mod-ssl 
				removed bind9
		
		addifnotexists	
		fix php ini files for apache and cli to include mysql.so
		include "$app->confbase/named_ehcp.conf" to /etc/bind/named.conf
			removed 
		replacelineinfile
			"listen-on {", "listen-on { any;};" /etc/bin/dnamed.conf.options
			removed
		mkdir -p $ehcpinstalldir
		mkdir -p $ehcpinstalldir/../../named/
			removed
		
		
		
	installfiles 
		rm -Rf $ehcpinstalldir
		mkdir $ehcpinstalldir
		cp -Rf * $ehcpinstalldir
		chmod a+r -R $ehcpinstalldir
		mkdir -p /var/www/new/vhosts/ehcp
		cp $ehcpinstalldir/misc/redirect_index.html -p /var/www/new/vhosts/ehcp/index.html
		
	installmailserver
		removed (made into a stub) but would be a great place to configure dkim...
		
		(postfix and related...)
		if unattended... echo postrix postfix/main_mailer_type select Internet Site |debconf-set-selections
		echo postfix postfix/mailname string $(hostname) |debconf-set-selections
		
		if installmode extra/normal
			install roundcube, installphpmyadmin
		if light 
			install postfix, postfix-mysql, mysql-client, courier-authdaemon, courirer-authmysql, courier-authlib-mysql, courier-imap{ssl_ libsasl ..		
		restart mysql
		cp -rf /usr/share/phpmyadmin /var/www/new
		mailconfiguration ehcppass=...
		mailnamefix
		
	passvariablestoinstall2
		write vars to install2.1.php

run install2.php
	include install_lib.php, install2.1.php
	
	installsql
		check if old ehcp db... backup if present
		replacelineinfile dbrootpass,...config.php
			dbpass
			defaultlanguage
		
		filecontent = sql statement starting with "drop databawe if exists ehcp..."
		write filecontent to file ehcp1.sql
		mysql -u root -p < ehcp1.sql
		mysql -D ehcp -uroot -p <ehcp.sql
		cp config.php ...
		rm ehcp1.sql
		
		$app=new Application()
		app->connecttodb all below: $app...
				set_ehcp_dir
				setconfigvalue ehcpdir ehcpeinstalldir
					dnsip ip
					adminname username
						adminemail useemail
					disableditapachetemplate yset
					disableditdnstameplate yes
				updatepanelusers set password = md5(..._ email=useremail where panelusername=admin
				commandline=true				
	fail2ban install
		apt-get install fail2ban
		fail2ban_config
			cp ehcpinstalldir/fail2ban/ehcp.conf to /etc/fail2ban/filter.d/ehcp.conf
			cp ehcpinstalldir/fail2ban/apache-dos.conf /etc/failtoban/filter.d/apache-dos.conf
			if exists /etc/fail2ban/jail.local, cp ehcpinstalldir/fail2ban/jail.local /etc/fail2ban
				update jail.local with correct user_email
				update jail.local with [ehcp] and [apache-dos] sections
			restart fail2ban	
			
				
	install vsftpd server
		nuke proftpd
		apt-get install vsftpd
			useradd --home $vhostsdir --gid $app->ftpgroup -m --shell /bin/false $app->ftpuser
			cp /etc/vsftpd.conf /etc/vsftpd.conf_orig
			vsftpd_configuration
				modify /etc/pam.d/vsftpd
					modified to be sufficient and also allow system ftp usage
				write vsftpd.configuration file
					probably a good place to insert specific vsftpd_user_conf entries...
				
	install nginx webserer...only if > ubuntu 12.10
		how does this serve ehcp?  I assume it does instead of apache...
		
	installappacheserver
		apt-get install libapache2-mod-php5, php5
		rebuild_apache2_config2()
			copy entire /etc/apache2 directory to /etc/apache2/backupbyehcp.date
			add if not exists to /etc/apache2/apache2.conf:
				Include apachehcp_subdomains.conf
				Include apachehcp_auth.conf
				Include apachehcp_passivedomains.conf
				Include apachehcp.conf
				ServerName myserver
			alter /etc/apache2/envvars
				alter apache_run_user to $app->wwwuser
				alter apache_run_group to $app->wwwgroup	
			add if not exists to envvars 
				umask 111
			copy /etc/apache2/sites-available/default -> sites-available/default.original.date
			copy ehcpinstalldir/etc/apache2/default /etc/apache2/siteavailable/default
			copy this new default file to default.ehcpbackup.date and to 000-default (?)
			cp ehcp...apachetemplate* ehcpinstalldir
			cp ehcp...*template ehcpinstalldir
			cp ehcp...ports.conf /etc/apache2
			rm /etc/apache2/sites-enabled/*
			cp /etc/apache2/sites-available/default /etc/apache2/sites-enabled (why not symlink?)
			a2enmod rewrite, php5,expires,headers
			...
			...	
			
			
	if insatllmode > light, 
		install_mod_secure_install
			apt-get install libapache2-mod-evasive, libapache-mod-security
			get_mod_secure_rules
				wget mod_security_rules.tar.gz from www.dinofly.com...
				copy rules into place
			apache_mod_secure_config
				copy ehcp-supplied modsecure and modevasive apache config files in place
				modify modevasive config file
					set DOSEmailNotify to $user_email
			mod_secure_final
				a2enmod mod-evasive mod-security
	installfinish
		mailutils, bind stuff, webalizer, etc
		if installmode extra
			install postgrey, ffmpeg,php5...
			normal:	webalizer,php-pear,phpsysinfo,mailtuils,byobu
			light: bind9-host,php5-curl,php5-xmlrpc,php5-imap
			
		$app->loadConfig
		$app->adjust_webmail_dirs
			can be nuked...
		modify named.conf
			nuked
		stop sendmail/postfix
		configure phpmyadmin
		configure net2ftp
		restart apache, bind9, postfix
		reset apt/sources.list to original
		add ehcp to /etc/rc.local
		modifyehcp to logrotate.d
		restart mysql
		update -rc.d -f nginx remove
		update-rc.d apache2 defaults
		apparmor stop
		

mv ehcp/*install.?php /etc/ehcp
					
ubuntuVSFTPDFix
	12.04 replace vsftpd with ppa:thefrontiergroup/vsftpd
		...must be a bug...
		fixVSFTPConfig
			alter chroot_local_user-no to yes
			alter allow_writeable_chrrot-no to yes
			libldapfix
			aptget install libgcc1
			alter seccomp_sandbox=yes to no
			restart vsftpd
			
	
slaveDNSApparmorFix
	change an apparmor rule in /etc/apparmor.d/usr.sbin/named to make the bind dir read-write.
fixEHCPPerms
	set dir permissions and ownerships for var/www...
logDirFix
	set permissios to make log files writabel by ehcp probably.
changeApacheUser		
	change apache user to vsftpd ?
	change nginx user and php-fpm user too.	
nginxRateLimit
	
fixPHPConfig
	alter cli ini: ensure extension of mysql.o is there.  restart apache
	
genUbuntuFixes
	ubuntu changes things in 13+
disableRecursiveBIND
	block attacks and secures bind
secureApache
	remove Indexes from /var/www and set +FollowSymlinks
removeInstallSilently
restartDaemons
	killall and restart mysql
	restart apache2 and ehcp
installAntiSpaminfoMail
	only if extra installatinos....
		install spamassasin

...
launchPanel

	

		
									
		
		
		
		
		
	
		





